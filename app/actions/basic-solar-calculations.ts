"use server"

interface BasicSolarInput {
  zipcode: string
  monthlyBill: string
  monthlyKwh: string
  shading: "none" | "light" | "moderate" | "heavy"
  hasPool: boolean
  hasEv: boolean
  hasAdditions: boolean
}

interface BasicSolarResult {
  sunHours: number
  systemSizeKw: number
  panelsNeeded: number
  panelWattage: number
  estimatedCost: number
  taxCredit: number
  netCost: number
  monthlySavings: number
  annualSavings: number
  paybackYears: number
  co2Reduction: number
  annualProduction: number
  lifetimeSavings: number
  roiPercentage: number
  treesEquivalent: number
}

// Comprehensive ZIP code to sun hours database
const zipCodeSunHours: Record<string, number> = {
  // Utah - High sun hours
  "84101": 5.8,
  "84102": 5.8,
  "84103": 5.8,
  "84104": 5.8,
  "84105": 5.8,
  "84106": 5.8,
  "84107": 5.8,
  "84108": 5.8,
  "84109": 5.8,
  "84110": 5.8,
  "84111": 5.8,
  "84112": 5.8,
  "84113": 5.8,
  "84114": 5.8,
  "84115": 5.8,
  "84116": 5.8,
  "84117": 5.8,
  "84118": 5.8,
  "84119": 5.8,
  "84120": 5.8,
  "84121": 5.8,
  "84122": 5.8,
  "84123": 5.8,
  "84124": 5.8,
  "84125": 5.8,
  "84126": 5.8,
  "84127": 5.8,
  "84128": 5.8,
  "84129": 5.8,
  "84130": 5.8,
  "84131": 5.8,
  "84132": 5.8,
  "84133": 5.8,
  "84134": 5.8,
  "84135": 5.8,
  "84136": 5.8,
  "84138": 5.8,
  "84139": 5.8,
  "84141": 5.8,
  "84143": 5.8,
  "84144": 5.8,
  "84145": 5.8,
  "84147": 5.8,
  "84148": 5.8,
  "84150": 5.8,
  "84151": 5.8,
  "84152": 5.8,
  "84157": 5.8,
  "84158": 5.8,
  "84165": 5.8,
  "84170": 5.8,
  "84171": 5.8,
  "84180": 5.8,
  "84184": 5.8,
  "84190": 5.8,
  "84199": 5.8,

  // Arizona - Very high sun hours
  "85001": 6.5,
  "85002": 6.5,
  "85003": 6.5,
  "85004": 6.5,
  "85005": 6.5,
  "85006": 6.5,
  "85007": 6.5,
  "85008": 6.5,
  "85009": 6.5,
  "85010": 6.5,
  "85011": 6.5,
  "85012": 6.5,
  "85013": 6.5,
  "85014": 6.5,
  "85015": 6.5,
  "85016": 6.5,
  "85017": 6.5,
  "85018": 6.5,
  "85019": 6.5,
  "85020": 6.5,
  "85021": 6.5,
  "85022": 6.5,
  "85023": 6.5,
  "85024": 6.5,
  "85025": 6.5,
  "85026": 6.5,
  "85027": 6.5,
  "85028": 6.5,
  "85029": 6.5,
  "85030": 6.5,
  "85031": 6.5,
  "85032": 6.5,
  "85033": 6.5,
  "85034": 6.5,
  "85035": 6.5,
  "85036": 6.5,
  "85037": 6.5,
  "85038": 6.5,
  "85039": 6.5,
  "85040": 6.5,
  "85041": 6.5,
  "85042": 6.5,
  "85043": 6.5,
  "85044": 6.5,
  "85045": 6.5,
  "85046": 6.5,
  "85048": 6.5,
  "85050": 6.5,
  "85051": 6.5,
  "85053": 6.5,
  "85054": 6.5,
  "85055": 6.5,
  "85060": 6.5,
  "85061": 6.5,
  "85062": 6.5,
  "85063": 6.5,
  "85064": 6.5,
  "85065": 6.5,
  "85066": 6.5,
  "85067": 6.5,
  "85068": 6.5,
  "85069": 6.5,
  "85070": 6.5,
  "85071": 6.5,
  "85072": 6.5,
  "85073": 6.5,
  "85074": 6.5,
  "85075": 6.5,
  "85076": 6.5,
  "85078": 6.5,
  "85079": 6.5,
  "85080": 6.5,
  "85082": 6.5,
  "85083": 6.5,
  "85085": 6.5,
  "85086": 6.5,
  "85087": 6.5,
  "85201": 6.4,
  "85202": 6.4,
  "85203": 6.4,
  "85204": 6.4,
  "85205": 6.4,
  "85206": 6.4,
  "85207": 6.4,
  "85208": 6.4,
  "85209": 6.4,
  "85210": 6.4,
  "85212": 6.4,
  "85213": 6.4,
  "85214": 6.4,
  "85215": 6.4,
  "85216": 6.4,
  "85224": 6.4,
  "85225": 6.4,
  "85226": 6.4,
  "85233": 6.4,
  "85234": 6.4,
  "85236": 6.4,
  "85248": 6.4,
  "85249": 6.4,
  "85250": 6.3,
  "85251": 6.3,
  "85252": 6.3,
  "85253": 6.3,
  "85254": 6.3,
  "85255": 6.3,
  "85256": 6.3,
  "85257": 6.3,
  "85258": 6.3,
  "85259": 6.3,
  "85260": 6.3,
  "85261": 6.3,
  "85262": 6.3,
  "85263": 6.3,
  "85264": 6.3,
  "85266": 6.3,
  "85267": 6.3,
  "85268": 6.3,
  "85269": 6.3,
  "85271": 6.3,
  "85274": 6.3,
  "85275": 6.3,
  "85277": 6.3,
  "85280": 6.3,
  "85281": 6.3,
  "85282": 6.3,
  "85283": 6.3,
  "85284": 6.3,
  "85285": 6.3,
  "85286": 6.3,
  "85287": 6.3,
  "85295": 6.3,
  "85296": 6.3,
  "85297": 6.3,
  "85298": 6.3,
  "85299": 6.3,

  // California - High sun hours
  "90001": 5.9,
  "90002": 5.9,
  "90003": 5.9,
  "90004": 5.9,
  "90005": 5.9,
  "90006": 5.9,
  "90007": 5.9,
  "90008": 5.9,
  "90009": 5.9,
  "90010": 5.9,
  "90011": 5.9,
  "90012": 5.9,
  "90013": 5.9,
  "90014": 5.9,
  "90015": 5.9,
  "90016": 5.9,
  "90017": 5.9,
  "90018": 5.9,
  "90019": 5.9,
  "90020": 5.9,
  "90021": 5.9,
  "90022": 5.9,
  "90023": 5.9,
  "90024": 5.9,
  "90025": 5.9,
  "90026": 5.9,
  "90027": 5.9,
  "90028": 5.9,
  "90029": 5.9,
  "90030": 5.9,
  "90031": 5.9,
  "90032": 5.9,
  "90033": 5.9,
  "90034": 5.9,
  "90035": 5.9,
  "90036": 5.9,
  "90037": 5.9,
  "90038": 5.9,
  "90039": 5.9,
  "90040": 5.9,
  "90041": 5.9,
  "90042": 5.9,
  "90043": 5.9,
  "90044": 5.9,
  "90045": 5.9,
  "90046": 5.9,
  "90047": 5.9,
  "90048": 5.9,
  "90049": 5.9,
  "90056": 5.9,
  "90057": 5.9,
  "90058": 5.9,
  "90059": 5.9,
  "90101": 5.9,
  "90102": 5.9,
  "90103": 5.9,
  "90189": 5.9,
  "90201": 5.8,
  "90202": 5.8,
  "90210": 5.8,
  "90211": 5.8,
  "90212": 5.8,
  "90213": 5.8,
  "90220": 5.8,
  "90221": 5.8,
  "90222": 5.8,
  "90223": 5.8,
  "90224": 5.8,
  "90225": 5.8,
  "90230": 5.8,
  "90231": 5.8,
  "90232": 5.8,
  "90233": 5.8,
  "90234": 5.8,
  "90235": 5.8,
  "90236": 5.8,
  "90237": 5.8,
  "90238": 5.8,
  "90239": 5.8,
  "90240": 5.8,
  "90241": 5.8,
  "90242": 5.8,
  "90245": 5.8,
  "90247": 5.8,
  "90248": 5.8,
  "90249": 5.8,
  "90250": 5.8,
  "90251": 5.8,
  "90254": 5.8,
  "90255": 5.8,
  "90260": 5.8,
  "90261": 5.8,
  "90262": 5.8,
  "90263": 5.8,
  "90264": 5.8,
  "90265": 5.8,
  "90266": 5.8,
  "90267": 5.8,
  "90270": 5.8,
  "90272": 5.8,
  "90274": 5.8,
  "90275": 5.8,
  "90277": 5.8,
  "90278": 5.8,
  "90280": 5.8,
  "90290": 5.8,
  "90291": 5.8,
  "90292": 5.8,
  "90293": 5.8,
  "90294": 5.8,
  "90295": 5.8,
  "90301": 5.8,
  "90302": 5.8,
  "90303": 5.8,
  "90304": 5.8,
  "90305": 5.8,
  "90306": 5.8,
  "90307": 5.8,
  "90308": 5.8,
  "90309": 5.8,
  "90310": 5.8,
  "90311": 5.8,
  "90312": 5.8,

  // Texas - Good sun hours
  "75001": 5.2,
  "75002": 5.2,
  "75006": 5.2,
  "75007": 5.2,
  "75010": 5.2,
  "75011": 5.2,
  "75013": 5.2,
  "75014": 5.2,
  "75015": 5.2,
  "75016": 5.2,
  "75017": 5.2,
  "75019": 5.2,
  "75020": 5.2,
  "75021": 5.2,
  "75022": 5.2,
  "75023": 5.2,
  "75024": 5.2,
  "75025": 5.2,
  "75026": 5.2,
  "75027": 5.2,
  "75028": 5.2,
  "75029": 5.2,
  "75030": 5.2,
  "75032": 5.2,
  "75033": 5.2,
  "75034": 5.2,
  "75035": 5.2,
  "75038": 5.2,
  "75039": 5.2,
  "75040": 5.2,
  "75041": 5.2,
  "75042": 5.2,
  "75043": 5.2,
  "75044": 5.2,
  "75045": 5.2,
  "75046": 5.2,
  "75047": 5.2,
  "75048": 5.2,
  "75049": 5.2,
  "75050": 5.2,
  "75051": 5.2,
  "75052": 5.2,
  "75053": 5.2,
  "75054": 5.2,
  "75056": 5.2,
  "75057": 5.2,
  "75060": 5.2,
  "75061": 5.2,
  "75062": 5.2,
  "75063": 5.2,
  "75065": 5.2,
  "75067": 5.2,
  "75068": 5.2,
  "75069": 5.2,
  "75070": 5.2,
  "75071": 5.2,
  "75074": 5.2,
  "75075": 5.2,
  "75076": 5.2,
  "75077": 5.2,
  "75078": 5.2,
  "75080": 5.2,
  "75081": 5.2,
  "75082": 5.2,
  "75083": 5.2,
  "75085": 5.2,
  "75086": 5.2,
  "75087": 5.2,
  "75088": 5.2,
  "75089": 5.2,
  "75090": 5.2,
  "75091": 5.2,
  "75092": 5.2,
  "75093": 5.2,
  "75094": 5.2,
  "75095": 5.2,
  "75096": 5.2,
  "75097": 5.2,
  "75098": 5.2,
  "75099": 5.2,
  "75201": 5.1,
  "75202": 5.1,
  "75203": 5.1,
  "75204": 5.1,
  "75205": 5.1,
  "75206": 5.1,
  "75207": 5.1,
  "75208": 5.1,
  "75209": 5.1,
  "75210": 5.1,
  "75211": 5.1,
  "75212": 5.1,
  "75214": 5.1,
  "75215": 5.1,
  "75216": 5.1,
  "75217": 5.1,
  "75218": 5.1,
  "75219": 5.1,
  "75220": 5.1,
  "75221": 5.1,
  "75222": 5.1,
  "75223": 5.1,
  "75224": 5.1,
  "75225": 5.1,
  "75226": 5.1,
  "75227": 5.1,
  "75228": 5.1,
  "75229": 5.1,
  "75230": 5.1,
  "75231": 5.1,
  "75232": 5.1,
  "75233": 5.1,
  "75234": 5.1,
  "75235": 5.1,
  "75236": 5.1,
  "75237": 5.1,
  "75238": 5.1,
  "75240": 5.1,
  "75241": 5.1,
  "75242": 5.1,
  "75243": 5.1,
  "75244": 5.1,
  "75245": 5.1,
  "75246": 5.1,
  "75247": 5.1,
  "75248": 5.1,
  "75249": 5.1,
  "75250": 5.1,
  "75251": 5.1,
  "75252": 5.1,
  "75253": 5.1,
  "75254": 5.1,
  "75258": 5.1,
  "75260": 5.1,
  "75261": 5.1,
  "75262": 5.1,
  "75263": 5.1,
  "75264": 5.1,
  "75265": 5.1,
  "75266": 5.1,
  "75267": 5.1,
  "75270": 5.1,
  "75275": 5.1,
  "75277": 5.1,
  "75283": 5.1,
  "75284": 5.1,
  "75285": 5.1,
  "75286": 5.1,
  "75287": 5.1,
  "75294": 5.1,
  "75295": 5.1,
  "75301": 5.1,
  "75303": 5.1,
  "75310": 5.1,
  "75312": 5.1,
  "75313": 5.1,
  "75315": 5.1,
  "75320": 5.1,
  "75323": 5.1,
  "75326": 5.1,
  "75336": 5.1,
  "75339": 5.1,
  "75342": 5.1,
  "75354": 5.1,
  "75355": 5.1,
  "75356": 5.1,
  "75357": 5.1,
  "75359": 5.1,
  "75360": 5.1,
  "75363": 5.1,
  "75364": 5.1,
  "75367": 5.1,
  "75368": 5.1,
  "75370": 5.1,
  "75371": 5.1,
  "75372": 5.1,
  "75373": 5.1,
  "75374": 5.1,
  "75376": 5.1,
  "75378": 5.1,
  "75379": 5.1,
  "75380": 5.1,
  "75381": 5.1,
  "75382": 5.1,
  "75389": 5.1,
  "75390": 5.1,
  "75391": 5.1,
  "75392": 5.1,
  "75393": 5.1,
  "75394": 5.1,
  "75395": 5.1,
  "75396": 5.1,
  "75397": 5.1,
  "75398": 5.1,

  // Florida - Good sun hours
  "32801": 5.0,
  "32802": 5.0,
  "32803": 5.0,
  "32804": 5.0,
  "32805": 5.0,
  "32806": 5.0,
  "32807": 5.0,
  "32808": 5.0,
  "32809": 5.0,
  "32810": 5.0,
  "32811": 5.0,
  "32812": 5.0,
  "32814": 5.0,
  "32815": 5.0,
  "32816": 5.0,
  "32817": 5.0,
  "32818": 5.0,
  "32819": 5.0,
  "32820": 5.0,
  "32821": 5.0,
  "32822": 5.0,
  "32824": 5.0,
  "32825": 5.0,
  "32826": 5.0,
  "32827": 5.0,
  "32828": 5.0,
  "32829": 5.0,
  "32830": 5.0,
  "32831": 5.0,
  "32832": 5.0,
  "32833": 5.0,
  "32834": 5.0,
  "32835": 5.0,
  "32836": 5.0,
  "32837": 5.0,
  "32839": 5.0,
  "32853": 5.0,
  "32854": 5.0,
  "32855": 5.0,
  "32856": 5.0,
  "32857": 5.0,
  "32858": 5.0,
  "32859": 5.0,
  "32860": 5.0,
  "32861": 5.0,
  "32862": 5.0,
  "32867": 5.0,
  "32868": 5.0,
  "32869": 5.0,
  "32872": 5.0,
  "32877": 5.0,
  "32878": 5.0,
  "32885": 5.0,
  "32886": 5.0,
  "32887": 5.0,
  "32891": 5.0,
  "32896": 5.0,
  "32897": 5.0,
  "32898": 5.0,

  // New York - Lower sun hours
  "10001": 4.2,
  "10002": 4.2,
  "10003": 4.2,
  "10004": 4.2,
  "10005": 4.2,
  "10006": 4.2,
  "10007": 4.2,
  "10009": 4.2,
  "10010": 4.2,
  "10011": 4.2,
  "10012": 4.2,
  "10013": 4.2,
  "10014": 4.2,
  "10016": 4.2,
  "10017": 4.2,
  "10018": 4.2,
  "10019": 4.2,
  "10020": 4.2,
  "10021": 4.2,
  "10022": 4.2,
  "10023": 4.2,
  "10024": 4.2,
  "10025": 4.2,
  "10026": 4.2,
  "10027": 4.2,
  "10028": 4.2,
  "10029": 4.2,
  "10030": 4.2,
  "10031": 4.2,
  "10032": 4.2,
  "10033": 4.2,
  "10034": 4.2,
  "10035": 4.2,
  "10036": 4.2,
  "10037": 4.2,
  "10038": 4.2,
  "10039": 4.2,
  "10040": 4.2,
  "10041": 4.2,
  "10043": 4.2,
  "10044": 4.2,
  "10045": 4.2,
  "10055": 4.2,
  "10060": 4.2,
  "10065": 4.2,
  "10069": 4.2,
  "10075": 4.2,
  "10080": 4.2,
  "10081": 4.2,
  "10087": 4.2,
  "10090": 4.2,
  "10101": 4.2,
  "10102": 4.2,
  "10103": 4.2,
  "10104": 4.2,
  "10105": 4.2,
  "10106": 4.2,
  "10107": 4.2,
  "10108": 4.2,
  "10109": 4.2,
  "10110": 4.2,
  "10111": 4.2,
  "10112": 4.2,
  "10113": 4.2,
  "10114": 4.2,
  "10115": 4.2,
  "10116": 4.2,
  "10117": 4.2,
  "10118": 4.2,
  "10119": 4.2,
  "10120": 4.2,
  "10121": 4.2,
  "10122": 4.2,
  "10123": 4.2,
  "10124": 4.2,
  "10125": 4.2,
  "10126": 4.2,
  "10128": 4.2,
  "10129": 4.2,
  "10130": 4.2,
  "10131": 4.2,
  "10132": 4.2,
  "10133": 4.2,
  "10138": 4.2,
  "10150": 4.2,
  "10151": 4.2,
  "10152": 4.2,
  "10153": 4.2,
  "10154": 4.2,
  "10155": 4.2,
  "10156": 4.2,
  "10157": 4.2,
  "10158": 4.2,
  "10159": 4.2,
  "10160": 4.2,
  "10161": 4.2,
  "10162": 4.2,
  "10163": 4.2,
  "10164": 4.2,
  "10165": 4.2,
  "10166": 4.2,
  "10167": 4.2,
  "10168": 4.2,
  "10169": 4.2,
  "10170": 4.2,
  "10171": 4.2,
  "10172": 4.2,
  "10173": 4.2,
  "10174": 4.2,
  "10175": 4.2,
  "10176": 4.2,
  "10177": 4.2,
  "10178": 4.2,
  "10179": 4.2,
  "10185": 4.2,
  "10199": 4.2,
  "10203": 4.1,
  "10204": 4.1,
  "10205": 4.1,
  "10206": 4.1,
  "10207": 4.1,
  "10208": 4.1,
  "10209": 4.1,
  "10210": 4.1,
  "10211": 4.1,
  "10212": 4.1,
  "10213": 4.1,
  "10214": 4.1,
  "10215": 4.1,
  "10216": 4.1,
  "10217": 4.1,
  "10218": 4.1,
  "10221": 4.1,
  "10222": 4.1,
  "10223": 4.1,
  "10224": 4.1,
  "10225": 4.1,
  "10226": 4.1,
  "10228": 4.1,
  "10229": 4.1,
  "10230": 4.1,
  "10231": 4.1,
  "10232": 4.1,
  "10233": 4.1,
  "10234": 4.1,
  "10235": 4.1,
  "10236": 4.1,
  "10237": 4.1,
  "10238": 4.1,
  "10239": 4.1,
  "10240": 4.1,
  "10241": 4.1,
  "10242": 4.1,
  "10243": 4.1,
  "10244": 4.1,
  "10245": 4.1,
  "10246": 4.1,
  "10247": 4.1,
  "10248": 4.1,
  "10249": 4.1,
  "10250": 4.1,
  "10251": 4.1,
  "10252": 4.1,
  "10253": 4.1,
  "10254": 4.1,
  "10255": 4.1,
  "10256": 4.1,
  "10257": 4.1,
  "10258": 4.1,
  "10259": 4.1,
  "10260": 4.1,
  "10261": 4.1,
  "10265": 4.1,
  "10268": 4.1,
  "10269": 4.1,
  "10270": 4.1,
  "10271": 4.1,
  "10272": 4.1,
  "10273": 4.1,
  "10274": 4.1,
  "10275": 4.1,
  "10276": 4.1,
  "10277": 4.1,
  "10278": 4.1,
  "10279": 4.1,
  "10280": 4.1,
  "10281": 4.1,
  "10282": 4.1,
  "10285": 4.1,
  "10286": 4.1,

  // Default fallback for unknown ZIP codes
}

export async function calculateBasicSolar(input: BasicSolarInput): Promise<BasicSolarResult> {
  const monthlyBill = Number.parseFloat(input.monthlyBill)
  const monthlyKwh = Number.parseFloat(input.monthlyKwh)

  // Get sun hours for ZIP code
  const sunHours = zipCodeSunHours[input.zipcode] || 4.5 // Default to national average

  // Shading adjustments
  const shadingMultipliers = {
    none: 1.0,
    light: 0.95,
    moderate: 0.85,
    heavy: 0.7,
  }

  const effectiveSunHours = sunHours * shadingMultipliers[input.shading]

  // Additional energy usage adjustments
  let adjustedMonthlyKwh = monthlyKwh
  if (input.hasPool) adjustedMonthlyKwh *= 1.15 // 15% increase for pool
  if (input.hasEv) adjustedMonthlyKwh *= 1.25 // 25% increase for EV
  if (input.hasAdditions) adjustedMonthlyKwh *= 1.1 // 10% increase for planned additions

  // System calculations
  const annualKwh = adjustedMonthlyKwh * 12
  const systemEfficiency = 0.85 // 85% system efficiency
  const systemSizeKw = annualKwh / (effectiveSunHours * 365 * systemEfficiency)

  // Panel calculations
  const panelWattage = 400 // Standard 400W panels
  const panelsNeeded = Math.ceil((systemSizeKw * 1000) / panelWattage)

  // Cost calculations
  const costPerWatt = 3.5 // $3.50 per watt installed
  const estimatedCost = systemSizeKw * 1000 * costPerWatt
  const taxCredit = estimatedCost * 0.3 // 30% federal tax credit
  const netCost = estimatedCost - taxCredit

  // Production and savings
  const annualProduction = systemSizeKw * effectiveSunHours * 365 * systemEfficiency
  const electricityRate = monthlyBill / monthlyKwh // Calculate rate from bill
  const annualSavings = annualProduction * electricityRate
  const monthlySavings = annualSavings / 12

  // Financial metrics
  const paybackYears = netCost / annualSavings
  const lifetimeSavings = annualSavings * 25 - netCost // 25-year system life
  const roiPercentage = Math.round((lifetimeSavings / netCost) * 100)

  // Environmental impact
  const co2Reduction = Math.round(annualProduction * 0.7) // 0.7 lbs CO2 per kWh
  const treesEquivalent = Math.round(co2Reduction / 48) // 48 lbs CO2 per tree per year

  return {
    sunHours: Math.round(sunHours * 10) / 10,
    systemSizeKw: Math.round(systemSizeKw * 100) / 100,
    panelsNeeded,
    panelWattage,
    estimatedCost: Math.round(estimatedCost),
    taxCredit: Math.round(taxCredit),
    netCost: Math.round(netCost),
    monthlySavings: Math.round(monthlySavings),
    annualSavings: Math.round(annualSavings),
    paybackYears: Math.round(paybackYears * 10) / 10,
    co2Reduction,
    annualProduction: Math.round(annualProduction),
    lifetimeSavings: Math.round(lifetimeSavings),
    roiPercentage,
    treesEquivalent,
  }
}
